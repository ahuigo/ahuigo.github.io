---
title: cass node replicate
date: 2022-03-11
private: true
---
# replicate
cass 数据是按照column family（table）进行组织。
1. 一行数据，通过这一行的partition key唯一标识。
2. 一行数据的一个副本被称作一个replica。
2. 数据第一次被保存，也被称作创建数据的第一个replica。

Cassandra是一个点对点系统，分必机制为：
1. 创建数据副本和数据的分发都是在一组节点之间互相进行的。
2. Cassandra使用一致性哈希（consistent hashing）机制在集群里分发数据。
3. 每个集群，配置了一个分区器（partitioner）来对每个partition key进行哈希运算。哈希运算的结果决定了这一行数据应该被保存到哪个节点。

## 分区器（Partitioners）
一个分区器就是一个用来计算partition key哈希值的一个哈希函数。

一个集群，有一个全局唯一的分区器的配置。Cassandra的默认的分区器是Murmur3Partitioner:

    Murmur3Partitioner（默认）：基于MurmurHash哈希算法
    RandomPartitioner：基于MD5哈希算法
    ByteOrderedPartitioner：根据partition key的bytes进行有序分区
        它允许按照partition key进行条件范围查询。也就是说，可以像关系型数据库的主键那样，通过游标，有序遍历所有的partition key
        缺点：容易造成热点（hotspot），多个表的数据的负载均衡不平均

## Replication策略
同一行数据在多个节点存储replica来确保可靠性和容错性。

    replication factor=1表示一行数据，只会有一个replica，被保存在唯一一个节点上。
    replication factor=2表示一行数据有两个副本，每个副本保存在不同的节点上。

Cassandra内置了两种类型的replication策略：

    SimpleStrategy：用于单个数据中心。如果有可能以后会有多个数据中心，应该用NetworkTopologyStrategy
    NetworkTopologyStrategy：对绝大多数部署方式，都强烈推荐该策略，因为今后的扩展更容易

关于每个数据中心应该配置几个replica? 最常用的两种配置replica的策略是：

    每个数据中心2个replica：基于这种配置，对于每个数据中心，即使单个节点故障，还是能够支持consistency level ONE的本地读
    每个数据中心3个replica：基于这种配置，对于每个数据中心，即使单个节点故障，还是能够支持consistency level LOCAL_QUORUM的本地读；即使2两个节点故障，还是能够支持consistency level ONE的本地读

# 可调节的一致性
对一个读或者写操作，所谓可调节的一致性的概念，指发起请求的客户端，可以通过consistency level参数，指定本次请求，需要的一致性。
https://teddymaef.github.io/learncassandra/cn/replication/turnable_consistency.html

## 写操作的Consistency Level
写操作的consistency level指定了写操作在通知客户端请求成功之前，必须确保已经成功完成写操作的replica的数量。

    ANY	任意一个节点写操作已经成功。
    ONE	任意一个replica节点写操作已经成功。	
    ALL	写操作必须将指定行的数据写到所有replica节点的commit log和memtable。	相对于其他级别提供最高的一致性和最低的可用性。
    EACH_QUORUM	写操作必须将指定行的数据写到每个数据中心的quorum数量的replica节点的commit log和memtable。	用于多数据中心集群严格的保证相同级别的一致性。

## 多数据中心写replica
对于远程数据中心，会在每个远程数据中心的节点中，选择一个作为远程数据中心中的coordinator。本地数据中心的coordinator，只和每个远程数据中心的coordinator节点通信。

如果使用`consistency level ONE或者LOCAL_QUORUM`，coordinator只需要和本地数据中心的节点通信。可以避免，跨数据中心的的通信影响写操作性能。

![](/img/db/cass/write_access_multidc.png)

## 读操作的Consistency Level
    ALL	向所有replica节点查询数据，返回所有的replica返回的数据中，timestamp最新的数据。
    EACH_QUORUM	向每个数据中心内quorum数量的replica节点查询数据，返回时间戳最新的数据。	同LOCAL_QUORUM。
    QUORUM	读取所有数据中心中quorum数量的节点的结果，返回合并后timestamp最新的结果。
    ONE	返回由snitch决定的最近的replica返回的结果。默认情况下，后台会触发read repair确保其他replica的数据一致。	
    TWO	返回两个最近的replica的最新数据。	和ONE类似。

QUORUM级别确保数据写到指定quorum数量的节点。一个quorum的值由下面的公式四舍五入计算而得：

    quorum=(sum_of_replication_factors / 2) + 1
    sum_of_replication_factors指每个数据中心的所有replication_factor设置的总和。

例如
1. 如果某个单数据中心的replication factor是3，quorum值为2-表示集群可以最多容忍1个节点down。
2. 如果replication factor是6，quorum值为4-表示集群可以最多容忍2个节点down。
3. 如果是双数据中心，每个数据中心的replication factor是3，quorum值为4-表示集群可以最多容忍2个节点down(2*3-4)。如果是5数据中心，每个数据中心的replication factor of 3，quorum值为8 (5*3-8=7)。

## 读操作网络图


# Reference: 
https://teddymaef.github.io/learncassandra/cn/replication/data_replication.html