---
title: ultra server
date: 2022-09-17
private: true
---
# ultra server
## start server
deno run -A ./tools/dev.ts

    // 1. static server(4507)
    serve((request) => { }, {
        port: 4507,
        async onListen({ port, hostname }) {
            // 2. framework server(ssr, port=8000)
            // deno run -A --watch --config deno.dev.json ./server.tsx // cwd: examplePath
    })
    
## server.tsx
app/server.tsx

    // server.tsx
    1. server = await createServer(options={ importMapPath, browserEntrypoint: ./client.tsx})
        // ultra/lib/server.ts
        1. root = Deno.cwd()
        2. server = new UltraServer(root,{mode:'development',entrypoint:client.tsx,importMapPath,...}) 
            // ultra/lib/ultra.ts, UltraServer extends Hono
            1. this.use("*", logger(logFn))
                1. logger=hono.logger
        2. server.init() 
            // ultra/lib/ultra.ts, UltraServer extends Hono
            1. this.importMap = this.#parseJsonFile(this.importMapPath)
            2. this.entrypoint = this.#prepareEntrypoint(this.importMap);
                1. return toUltraUrl(this.root, this.entrypoint, this.mode)!;
                    1. /_ultra/compiler+ path.replace(root, "")
        2. server.get('*', serverStatic('./public'))
            1. handler = async serveStatic(conext,next){}
                // lib/middleware/serveStatic.ts
                1. response = fetch path
                2. response.body
                3. notFound && next()
            2. get(*, handler) // 注册为middleware、router
        2. server.get('*', serverStatic('./'))
        2. server.get('/_ultra/compiler', compiler('./'))
            // lib/middleware/compiler.ts
            1. compiler()=(context: Context, next: Next) => {}
                1. source = await fetch(url)
                2. transformed = await transformSource(source,options)
                3. { code, map } = transformed;
                4. code = insertSourceMap(code, map, url);
                5. return new Response(code)
    2. server.get('*',handler)
        1. result = server.render(<App/>, ctx)
            1. return this.renderWithContext(Component, undefined, options);
        1. result = server.renderWithContext(<App/>, ctx, {...})
            // lib/ultra.ts
            1. return renderToStream(App=Component, context, {this.importMap,...})
                // lib/render.ts
                1. renderStream = await renderToInitialStream(h(UltraProvider,{baseUrl,children:App,context}))
                    // lib/provider.ts
                    1. UltraProvider(context,baseUrl)
                    2. ServerContextProvider
                    3. DataStreamProvider
                    4. InsertedHTML
                    5. EnvProvider
                    6. AssetProvider
                    7. IslandProvider
                2. return continueFromInitialStream(renderStream, {importMap,...})
                    // lib/stream.ts
                    1. transforms=[createBufferedTransformStream(), createImportMapInjectionStream(importMap,...)]
        2. return context.body(result, statusCode?, headers)
    3. serve(server.fetch)