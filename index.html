<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ahuigo's blog">
    <meta name="author" content="ahuigo">
    <link href="https://cdn.bootcss.com/bulma/0.7.1/css/bulma.min.css" rel="stylesheet">
    <link href="/css/main.css" rel="stylesheet">

    <script src="https://unpkg.com/vue/dist/vue.js"></script>
    <script src="https://unpkg.com/vue-router/dist/vue-router.js"></script>

    <link href="https://cdn.bootcss.com/highlight.js/9.12.0/styles/agate.min.css" rel="stylesheet">
    <script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>

    <link href="https://cdn.bootcss.com/KaTeX/0.10.0-alpha/katex.min.css" rel="stylesheet">
    <script src="https://cdn.bootcss.com/KaTeX/0.10.0-alpha/katex.min.js"></script>
    <script src="/js/marked.js"></script>
    <script src="/js/page.js"></script>
    <style>
        .folder::before { content: 'ğŸ“˜'; }
        .folder::first-letter { text-transform: capitalize; }
        .file::before { content: 'ğŸ”µ'; }

        div > ul, div > ol{
            padding-left:20px;
        }
        .left, .middle, .right, .left-middle{
            background-color: #fff;
            overflow: auto;
            padding:0 8px
        }
        .left{
            flex:2;
        }
        .middle{
            flex:8;
        }
        .right{
            flex:3; 
        }
        .left-middle{
            flex:10;
            display:flex;
            overflow:auto;
        }
    </style>
</head>

<body class="layout-documentation page-layout">
    <div style="padding:1.5rem;border-bottom:1px solid" class="level  hero is-dark">
        <div class="level-left">
            <div class="level-item title"> ahuigo çš„è‡ªç•™åœ° </div>
            <pre>
    â˜ã€€âœˆã€€ã€€ â˜ã€€ã€€ğŸš
ã€€ğŸ¬ğŸ¨ğŸ«ğŸ¢ğŸ¤ğŸ¥ğŸ¦ğŸª
ğŸ‘¬ğŸŒ² /ã€€ğŸš¶ğŸš  \ğŸŒ³
ã€€ğŸŒ³/ã€€ğŸš˜   ğŸƒã€€\ğŸŒ´ğŸˆ
ğŸŒ´ /ã€€ ğŸ¢  ğŸš”   \ğŸŒ²
ğŸŒ²/    ğŸš–ã€€  ã€€ã€€  \ğŸŒ³ğŸ‘­ </pre>
        </div>

        <div class="level-right">
            <p class="level-item">
                <strong></strong>
            </p>
        </div>
    </div>
    <div id="app" style="display:flex">
        <div class="left-middle">
            <tree-folder class="left" :show="show" :nodes="nodes"></tree-folder>
            <router-view class="middle"></router-view>
        </div>
        <div class="right">
            <div id="toc"></div>
            <iframe height="450" marginheight="0" border="0" src="https://music.163.com/outchain/player?type=0&amp;id=7314556&amp;auto=0&amp;height=430"
                frameborder="no"></iframe>
        </div>
    </div>
</body>
<template id="tree-folder">
    <ul v-if="show" class="menu">
        <li v-for="(file,index) in nodes" :key="file.path">
            <div v-if="file.type==='dir'" :type="file.type" @click="openFolder(file)" class="folder">{{file.name.toUpperCase()}}
            </div>
            <router-link v-else :type="file.type" class="file" :to="'/'+file.path">{{file.name.slice(0,-3)}} </router-link>
            <tree-folder v-if="file.nodes" :show="file.show" :nodes="file.nodes"></tree-folder>
        </li>
    </ul>
</template>
<template id="md">
    <div>
        <div id="content" v-html="marked(md)"></div>
        <div id="disqus_thread">
            <button id="show-comments" onclick="disqus();return false;">Load Comments</button>
        </div>
    </div>
</template>

<script>
    function disqus() {
        if (!window.DISQUS) {
            var d = document, s = d.createElement('script');
            s.src = 'https://ahuigo.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
            s.onload = function () {
                console.log('onload disqus')
                disqus_reset()
            }
        } else {
            disqus_reset()
        }
    }
    function disqus_reset() {
        if (window.DISQUS) {
            DISQUS.reset({
                reload: true,
                config: function () {
                    this.page.url = window.location.href.replace('#', '#!');
                    this.page.identifier = window.location.hash.slice(1);
                    this.page.title = document.querySelector('#content h1').innerText.split(' ').slice(1).join(' ')
                }
            });

        }
    }

    Vue.component('tree-folder', {
        template: '#tree-folder',
        props: ['nodes', 'show'],
        methods: {
            openFolder(file) {
                if (!file.nodes) {
                    file.show = true
                    Vue.set(file, 'nodes', [{ type: 'file', name: "loading...", path: '' }]);
                    this.$root.fetchFolder(file).then(n => console.log(n))
                } else {
                    Vue.set(file, 'show', !file.show);
                }
            },
        },
    });

    marked.setOptions({
        gfm: true,
        breaks: true,
        latexRender: katex.renderToString.bind(katex),
    });

    const routes = [
        { path: '/bar', component: { template: '<div>bar</div>' } },
        { path: '/', redirect: '/post/ria/js-promise.md' },
        {
            path: '/post/*',
            component: {
                template: '#md',
                data() {
                    return {
                        md: '',
                    }
                },
                props: [],
                watch: {
                    '$route'(to, from) {
                        this.fetchMd()
                    }
                },
                mounted: function () {
                    console.log('mounted')
                    this.$nextTick(function () {
                    })
                },
                updated() {
                    disqus_reset()
                    console.log('updated')
                    document.querySelectorAll('pre code').forEach(function (e) {
                        return hljs.highlightBlock(e, '    ');
                    });
                    const toc = document.querySelector('#toc');
                    if (toc.children.length) {
                        toc.children[0].replaceWith(createToc(this.$el))
                    } else {
                        toc.appendChild(createToc(this.$el))
                    }
                },
                methods: {
                    fetchMd(path) {
                        path = this.$route.path
                        fetch(path).then(response => {
                            response.text().then(data => {
                                if (data.substr(0, 4) === '---\n') {
                                    var pos = data.substr(0, 300).nthIndex('---\n', 2)
                                    data = data.substr(pos);
                                }
                                data = data.replace(/\n/g, '\t\n')
                                this.md = data
                            })
                        })
                    },
                    marked: function (text) {
                        console.log('[text]')
                        return marked(text)
                    },
                },
                created() {
                    console.log('before created')
                    this.fetchMd()
                },
            }
        },
    ];

    const app = new Vue({
        router: new VueRouter({
            routes,
            scrollBehavior(to, from, savedPosition) {
                return { x: 0, y: 0 }
            },
        }),
        data() {
            return {
                nodes: [],
                path: 'post',
                show: true,
                name: 'ahuigo',
            };
        },
        methods: {
            fetchFolder(file) {
                return fetch('https://api.github.com/repos/ahuigo/a/contents/' + file.path, {
                }).then(r => r.json()).then(data => {
                    let nodes = data.map(v => ({ name: v.name, path: v.path, type: v.type, show: true }))
                        .filter((v) =>
                            !(
                                v.type == 'dir'
                                && ['ai', 'atom'].includes(v.name)
                            )
                        );
                    Vue.set(file, 'nodes', nodes);
                    return [null, nodes]
                }).catch(err => {
                    console.log([err])
                    return [err]
                })
            },
        },
        created: function () {
            this.fetchFolder(this.$data)
        }
    }).$mount('#app')
</script>

</html>